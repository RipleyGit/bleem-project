import{S,o as d,Q as O}from"./index.BLQPjP0P.js";import{a as f,y as j,r as c,f as R,q as y,Z as h,o as x,b as $}from"./vue.DKOcwzik.js";const v=f({name:"global-websocket",props:{uri:{type:String}},emits:["rollback"],setup(m,{emit:l}){const b=l,p=m,e=j({webSocket:c(),lockReconnect:!1,maxReconnect:6,reconnectTime:0,heartbeat:{interval:3e4,timeout:1e4,pingTimeoutObj:c(),pongTimeoutObj:c(),pingMessage:JSON.stringify({type:"ping"})}}),a=R(()=>S.getToken());y(()=>{i()}),h(()=>{e.webSocket.close(),s(e.heartbeat)});const i=()=>{let o,t=window.location.host,w=`${window.location.protocol==="https:"?"wss:":"ws:"}//${t}${o}${d.adaptationUrl(p.uri)}?access_token=${a.value}`;e.webSocket=new WebSocket(w),e.webSocket.onopen=g,e.webSocket.onerror=u,e.webSocket.onmessage=k,e.webSocket.onclose=T},n=()=>{a&&(e.lockReconnect||e.maxReconnect!==-1&&e.reconnectTime>e.maxReconnect||(e.lockReconnect=!0,setTimeout(()=>{e.reconnectTime++,i(),e.lockReconnect=!1},5e3)))},s=o=>{o.pingTimeoutObj&&clearTimeout(o.pingTimeoutObj),o.pongTimeoutObj&&clearTimeout(o.pongTimeoutObj)},r=()=>{const o=e.webSocket,t=e.heartbeat;s(t),t.pingTimeoutObj=setTimeout(()=>{o.readyState===1?(o.send(t.pingMessage),t.pongTimeoutObj=setTimeout(()=>{o.close()},t.timeout)):n()},t.interval)},g=()=>{r(),e.reconnectTime=0},u=()=>{n()},T=()=>{n()},k=o=>{r();const t=o.data;t.indexOf("pong")>0||(O.warning({title:"\u6D88\u606F\u63D0\u9192",dangerouslyUseHTMLString:!0,message:t+"\u8BF7\u53CA\u65F6\u5904\u7406",offset:60}),b("rollback",t))};return(o,t)=>(x(),$("div"))}});export{v as default};
